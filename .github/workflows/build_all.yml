name: GodotJS Dependencies (All)

on:
  workflow_dispatch:
    inputs:
      bundle_tag:
        description: 'package version tag'
        type: string
        required: true
      v8_version:
        description: 'v8 version tag'
        type: choice
        options:
          - "13.5.119"
          - "12.9.202.28" # 2022
          - "12.4.254.21" # 2019
        required: true
        default: "13.5.119"

jobs:
  v8_android:
    uses: ./.github/workflows/build_v8_android.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_ios:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_v8_ios.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_macos:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_v8_macos.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_linux:
    uses: ./.github/workflows/build_v8_linux.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  v8_windows:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_v8_windows.yml
    with:
      v8_version: ${{ inputs.v8_version }}
    secrets: inherit

  lws_linux:
    uses: ./.github/workflows/build_lws_linux.yml
    secrets: inherit

  # Android LWS builds (use NDK r23c toolchain)
  lws_android:
    uses: ./.github/workflows/build_lws_android.yml
    secrets: inherit

  lws_ios:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_lws_ios.yml
    secrets: inherit

  lws_macos:
    if: ${{ vars.SKIP_APPLE != 'true' }}
    uses: ./.github/workflows/build_lws_macos.yml
    secrets: inherit

  lws_windows:
    if: ${{ vars.SKIP_WINDOWS != 'true' }}
    uses: ./.github/workflows/build_lws_windows.yml
    secrets: inherit

  publish:
    uses: ./.github/workflows/publish.yml
    needs:
      - v8_android
      - v8_ios
      - v8_macos
      - v8_linux
      - v8_windows
      - lws_linux
      - lws_android
      - lws_ios
      - lws_macos
      - lws_windows
    if: >-
      ${{
        always() &&
        (needs.v8_android.result == 'success' || needs.v8_android.result == 'skipped') &&
        (needs.v8_ios.result == 'success' || needs.v8_ios.result == 'skipped') &&
        (needs.v8_macos.result == 'success' || needs.v8_macos.result == 'skipped') &&
        (needs.v8_linux.result == 'success' || needs.v8_linux.result == 'skipped') &&
        (needs.v8_windows.result == 'success' || needs.v8_windows.result == 'skipped') &&
        (needs.lws_linux.result == 'success' || needs.lws_linux.result == 'skipped') &&
        (needs.lws_android.result == 'success' || needs.lws_android.result == 'skipped') &&
        (needs.lws_ios.result == 'success' || needs.lws_ios.result == 'skipped') &&
        (needs.lws_macos.result == 'success' || needs.lws_macos.result == 'skipped') &&
        (needs.lws_windows.result == 'success' || needs.lws_windows.result == 'skipped')}}
    with:
      bundle_tag: ${{ inputs.bundle_tag }}
      v8_version: ${{ inputs.v8_version }}